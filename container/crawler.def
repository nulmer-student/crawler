BootStrap: library
From: ubuntu


%post
    # Install system dependencies
    apt-get -y update
    apt-get -y install sudo wget python3 gnupg lsb-release \
               software-properties-common \
               vim git cmake pip \
               mariadb-server libmariadb3 libmariadb-dev

    add-apt-repository -y ppa:ubuntu-toolchain-r/test
    apt -y install g++-13

    pip install git-python requests python-dotenv mariadb #"mariadb==1.0.11"

    # Setup mariadb
    killall mariadbd || true
    service mariadb start
    mariadb -e "create database crawler"
    mariadb -e "create user crawler@localhost"
    mariadb -e "grant all privileges on crawler.* to crawler@localhost"
    mariadb -e "create user stats@localhost"
    mariadb -e "grant select on crawler.* to stats@localhost"

    # Setup the crawler
    cd /opt
    git clone https://github.com/nulmer-student/crawler.git

    # Setup Runner
    cd /opt/crawler/runner
    mkdir -p /opt/crawler/runner/logs
    cp /opt/.env /opt/crawler/runner/.env
    # TODO: Fix database user

    # Setup Miner
    cd /opt/crawler/miner
    mkdir build
    cd build
    cmake .. -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_CXX_COMPILER=$(which g++-13)
    make -j12


%files
   ../runner/.env /opt/.env


%environment
    export LC_ALL=C
    export PATH=/usr/games:$PATH


%runscript
    mariadb --version


%labels
    Author Nathan Ulmer
