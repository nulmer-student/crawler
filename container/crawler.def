BootStrap: library
From: ubuntu


%post
    # Install system dependencies
    apt-get -y update
    apt-get -y install sudo wget python3 gnupg lsb-release \
               software-properties-common \
               vim git pip \
               mariadb-server libmariadb3 libmariadb-dev \
               cmake ninja-build lld \

    # Install gcc 13
    add-apt-repository -y ppa:ubuntu-toolchain-r/test
    apt -y install g++-13

    # Setup mariadb
    killall mariadbd || true
    service mariadb start
    mariadb -e "create database crawler"
    mariadb -e "create user crawler@localhost"
    mariadb -e "grant all privileges on crawler.* to crawler@localhost"
    mariadb -e "create user stats@localhost"
    mariadb -e "grant select on crawler.* to stats@localhost"

    # Setup the crawler
    cd /opt
    git clone https://github.com/nulmer-student/crawler.git

    # Setup Runner
    pip install git-python requests python-dotenv mariadb

    cd /opt/crawler/runner
    mkdir -p /opt/crawler/runner/logs
    cp /opt/.env /opt/crawler/runner/.env

    # Setup Miner
    cd /opt/crawler/miner
    mkdir build
    cd build
    cmake .. -DCMAKE_BUILD_TYPE=Release \
             -DCMAKE_CXX_COMPILER=$(which g++-13)
    make -j12
    chmod +x /opt/crawler/miner/build/bin/miner

    # Install LLVM
    cd /opt
    wget https://apt.llvm.org/llvm.sh
    chmod +x llvm.sh
    ./llvm.sh 17

    # Build the cost model
    cd /opt
    git clone https://github.com/reza-ghanbari/llvm-project.git
    cd /opt/llvm-project
    git checkout analytical-cost-model

    mkdir build
    cd build
    cmake ../llvm \
        -GNinja \
        -DLLVM_OPTIMIZED_TABLEGEN=ON \
        -DLLVM_INSTALL_UTILS=ON \
        -DBUILD_SHARED_LIBS=ON \
        -DLLVM_ENABLE_RTTI=ON \
        -DLLVM_ENABLE_ASSERTIONS=ON \
        -DLLVM_INCLUDE_BENCHMARKS=OFF \
        -DLLVM_CCACHE_BUILD=OFF \
        -DLLVM_USE_NEWPM=ON \
        -DLLVM_PARALLEL_LINK_JOBS=2 \
        -DLLVM_TARGETS_TO_BUILD="X86" \
        -DCMAKE_BUILD_TYPE=Release \
        -DLLVM_ENABLE_PROJECTS="clang;clang-tools-extra;lld" \
        -DLLVM_USE_LINKER=lld \
        -DCMAKE_C_COMPILER=clang-17 \
        -DCMAKE_CXX_COMPILER=clang++-17
    ninja -j 12
    cmake --install . --prefix "/opt/llvm-bin"


%files
   ./.env /opt/.env


%environment
    export LC_ALL=C
    export PATH=/usr/games:$PATH


%runscript
    cd /opt/crawler/runner
    python3 main.py


%startscript
    cd /opt/crawler/runner
    python3 main.py


%labels
    Author Nathan Ulmer
